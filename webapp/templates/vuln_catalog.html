{% extends "layout.html" %}

{% block title %}Vulnerability Catalog{% endblock %}
{% block header_icon %}<i class="bi bi-bug-fill fs-4"></i>{% endblock %}
{% block header_title %}Vulnerability Catalog{% endblock %}
{% block active_page %}{% set active_page = 'vuln_catalog' %}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="vulnPacksTab" data-bs-toggle="tab" data-bs-target="#vulnPacks" type="button" role="tab">Vulnerability Packs</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="vulnCatalogTab" data-bs-toggle="tab" data-bs-target="#vulnCatalog" type="button" role="tab">Vulnerability Catalog</button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="vulnPacks" role="tabpanel">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <h5 class="mb-0">Vulnerability Catalog Packs (ZIP)</h5>
            <div class="small text-muted">
              Active catalog: <strong>{{ active_label or 'repo default (raw_datasources)' }}</strong>
              {% if active_id %}<span class="text-muted">({{ active_id }})</span>{% endif %}
              {% if items_count is not none %}<span class="text-muted">• {{ items_count }} entries</span>{% endif %}
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <div class="small text-muted mb-2">
                Upload a ZIP (or import from a URL) that contains directories/subdirectories.
                Every <em>valid vulnerability directory</em> must include a <code>docker-compose.yml</code>.
                All other files in those directories are stored and can be browsed/downloaded from this page.
                The active catalog is used by the Web UI and CLI when listing/selecting vulnerabilities.
              </div>

              <form class="row g-2 align-items-center" action="{{ url_for('vuln_catalog_packs_upload') }}" method="post" enctype="multipart/form-data">
                <div class="col-auto">
                  <input class="form-control" type="file" name="zip_file" accept="application/zip,.zip" required>
                </div>
                <div class="col-auto">
                  <button class="btn btn-primary" type="submit">Upload ZIP</button>
                </div>
              </form>

              <form class="row g-2 mt-2 align-items-center" action="{{ url_for('vuln_catalog_packs_import_url') }}" method="post">
                <div class="col-md-6">
                  <input class="form-control" type="url" name="zip_url" placeholder="https://example.com/vuln-catalog.zip" required>
                </div>
                <div class="col-auto">
                  <button class="btn btn-outline-primary" type="submit">Import from URL</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Label</th>
                      <th>Origin</th>
                      <th>Installed</th>
                      <th>Files</th>
                      <th style="width: 220px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in catalogs %}
                    <tr class="{{ 'table-success' if c.id == active_id else '' }}">
                      <td>
                        <div>
                          <strong>{{ c.label or c.id }}</strong>
                          {% if c.id == active_id %}
                            <span class="badge bg-success ms-2">Active</span>
                          {% endif %}
                        </div>
                        <div class="small text-muted">{{ c.id }}</div>
                      </td>
                      <td class="small">{{ c.origin or '' }}</td>
                      <td class="small">{{ c.installed_at or '' }}</td>
                      <td class="small" style="max-width: 720px; word-break: break-word;">
                        {% if c.compose_count %}
                          <div><span class="text-muted">Compose dirs:</span> <strong>{{ c.compose_count }}</strong></div>
                        {% endif %}
                        {% if c.content_dir %}
                          <div><span class="text-muted">Content:</span> <code>{{ c.content_dir }}</code></div>
                        {% endif %}
                        {% if c.csv_paths %}
                          {% for p in c.csv_paths %}
                            <div><span class="text-muted">Catalog:</span> <code>{{ p }}</code></div>
                          {% endfor %}
                        {% endif %}
                      </td>
                      <td>
                        <div class="d-flex gap-2 flex-wrap">
                          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('vuln_catalog_packs_browse', catalog_id=c.id) }}">Browse Files</a>
                          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('vuln_catalog_packs_download', catalog_id=c.id) }}">Download ZIP</a>
                          <form action="{{ url_for('vuln_catalog_packs_set_active', catalog_id=c.id) }}" method="post">
                            <button class="btn btn-sm btn-outline-success" type="submit" {% if c.id == active_id %}disabled{% endif %}>Set Active</button>
                          </form>
                          <form action="{{ url_for('vuln_catalog_packs_delete', catalog_id=c.id) }}" method="post" onsubmit="return confirm('Delete this vulnerability catalog pack?');">
                            <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                    {% if not catalogs %}
                    <tr><td colspan="5" class="text-muted">No vulnerability catalog packs installed yet. The system will use the repo default under <code>raw_datasources/</code>.</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>

        <div class="tab-pane fade" id="vulnCatalog" role="tabpanel">
          <div class="card mb-3">
            <div class="card-body">
              <div class="row g-2 align-items-center">
                <div class="col-md-6">
                  <input id="vulnCatalogFilter" class="form-control" placeholder="Filter vulnerabilities…" />
                </div>
              </div>
              <div class="small text-muted mt-2" id="vulnCatalogMeta"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm align-middle" id="vulnCatalogTable">
                  <thead>
                    <tr>
                      <th style="width: 60px;">#</th>
                      <th>Name</th>
                      <th>Type</th>
                      <th>From Source</th>
                      <th style="width: 180px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vulnCatalogBody"></tbody>
                </table>
              </div>
              <pre class="mt-3 small" id="vulnCatalogLog" style="max-height: 240px; overflow: auto;"></pre>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Vulnerability Test Modal -->
<div class="modal fade" id="vulnTestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Test Vulnerability</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <div><strong id="vulnTestName"></strong></div>
          <div class="small text-muted" id="vulnTestId"></div>
        </div>
        <div class="mt-3">
          <div class="small text-muted mb-1">Progress / Log</div>
          <pre class="small bg-light p-2" id="vulnTestLog" style="max-height: 300px; overflow: auto;"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="vulnTestRunBtn">Run</button>
      </div>
    </div>
  </div>
</div>

<script>
  const _vulnCatalogState = {
    active: null,
    items: [],
    selectedItem: null,
  };

  function _qs(id) { return document.getElementById(id); }

  function _setText(id, txt) {
    const el = _qs(id);
    if (!el) return;
    el.textContent = String(txt || '');
  }

  function _appendLog(id, line) {
    const el = _qs(id);
    if (!el) return;
    const cur = el.textContent || '';
    el.textContent = (cur ? (cur + '\n') : '') + String(line || '');
  }

  async function _fetchJson(url, opts) {
    const resp = await fetch(url, Object.assign({
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin',
    }, opts || {}));
    const text = await resp.text();
    let data = null;
    try { data = JSON.parse(text); } catch (e) { /* ignore */ }
    if (!resp.ok) {
      const msg = (data && data.error) ? data.error : (text || resp.statusText);
      throw new Error(msg);
    }
    return data;
  }

  async function _postJson(url, payload) {
    return _fetchJson(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(payload || {}),
    });
  }

  function _renderVulnCatalogTable() {
    const body = _qs('vulnCatalogBody');
    if (!body) return;
    body.innerHTML = '';

    const filter = String((_qs('vulnCatalogFilter') && _qs('vulnCatalogFilter').value) || '').trim().toLowerCase();
    const items = Array.isArray(_vulnCatalogState.items) ? _vulnCatalogState.items.slice() : [];

    const rows = items.filter(it => {
      if (!filter) return true;
      const nm = String(it.name || '').toLowerCase();
      const src = String(it.from_source || '').toLowerCase();
      return nm.includes(filter) || src.includes(filter) || String(it.id || '').includes(filter);
    });

    for (const it of rows) {
      const tr = document.createElement('tr');
      if (it.disabled) tr.classList.add('table-secondary');
      tr.innerHTML = `
        <td class="small">${String(it.id ?? '')}</td>
        <td>
          <div><strong>${String(it.name || '')}</strong></div>
          ${it.disabled ? '<div class="small text-muted">Disabled</div>' : ''}
        </td>
        <td class="small">${String(it.type || 'docker-compose')}</td>
        <td class="small" style="max-width: 420px; word-break: break-word;">${String(it.from_source || '')}</td>
        <td>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-primary" data-action="test">Test</button>
            <button class="btn btn-sm btn-outline-warning" data-action="toggle">${it.disabled ? 'Enable' : 'Disable'}</button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete">Delete</button>
          </div>
        </td>
      `;

      tr.querySelector('[data-action="test"]').addEventListener('click', () => openVulnTestModal(it));
      tr.querySelector('[data-action="toggle"]').addEventListener('click', async () => {
        try {
          _setText('vulnCatalogLog', '');
          _appendLog('vulnCatalogLog', `Toggling disabled for #${it.id} (${it.name})…`);
          await _postJson('/vuln_catalog_items/set_disabled', { item_id: it.id, disabled: !it.disabled });
          await loadVulnCatalogItems();
        } catch (e) {
          _appendLog('vulnCatalogLog', `Error: ${e}`);
        }
      });
      tr.querySelector('[data-action="delete"]').addEventListener('click', async () => {
        if (!confirm(`Delete vulnerability #${it.id} (${it.name}) from the active catalog?`)) return;
        try {
          _setText('vulnCatalogLog', '');
          _appendLog('vulnCatalogLog', `Deleting #${it.id} (${it.name})…`);
          await _postJson('/vuln_catalog_items/delete', { item_id: it.id });
          await loadVulnCatalogItems();
        } catch (e) {
          _appendLog('vulnCatalogLog', `Error: ${e}`);
        }
      });

      body.appendChild(tr);
    }

    if (!rows.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="text-muted">No vulnerabilities found.</td>`;
      body.appendChild(tr);
    }
  }

  async function loadVulnCatalogItems() {
    const metaEl = _qs('vulnCatalogMeta');
    if (metaEl) metaEl.textContent = 'Loading…';

    const data = await _fetchJson('/vuln_catalog_items_data');
    if (!data || data.ok === false) {
      const err = data && data.error ? data.error : 'Failed to load vulnerability catalog items';
      if (metaEl) metaEl.textContent = err;
      _vulnCatalogState.items = [];
      _renderVulnCatalogTable();
      return;
    }
    _vulnCatalogState.active = data.active || null;
    _vulnCatalogState.items = Array.isArray(data.items) ? data.items : [];
    const src = _vulnCatalogState.active && _vulnCatalogState.active.from_source ? String(_vulnCatalogState.active.from_source) : '';
    const activeLabel = _vulnCatalogState.active && _vulnCatalogState.active.label ? String(_vulnCatalogState.active.label) : 'repo default';
    if (metaEl) metaEl.textContent = `${_vulnCatalogState.items.length} items • Active: ${activeLabel}${src ? ' • From: ' + src : ''}`;
    _renderVulnCatalogTable();
  }

  function openVulnTestModal(item) {
    _vulnCatalogState.selectedItem = item || null;
    _setText('vulnTestName', item && item.name ? item.name : '');
    _setText('vulnTestId', item && item.id ? `#${item.id}` : '');
    _setText('vulnTestLog', '');
    const modal = new bootstrap.Modal(_qs('vulnTestModal'));
    modal.show();
  }

  async function runVulnTest() {
    const it = _vulnCatalogState.selectedItem;
    if (!it) return;
    _setText('vulnTestLog', '');
    _appendLog('vulnTestLog', `Testing #${it.id} (${it.name})…`);
    try {
      const data = await _postJson('/vuln_catalog_items/test', { item_id: it.id });
      if (data && data.log) _appendLog('vulnTestLog', data.log);
      if (data && data.ok) _appendLog('vulnTestLog', 'OK');
      else _appendLog('vulnTestLog', 'FAILED');
    } catch (e) {
      _appendLog('vulnTestLog', `Error: ${e}`);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const filter = _qs('vulnCatalogFilter');
    if (filter) filter.addEventListener('input', _renderVulnCatalogTable);
    const tab = _qs('vulnCatalogTab');
    if (tab) tab.addEventListener('shown.bs.tab', async () => {
      try { await loadVulnCatalogItems(); } catch (e) { _setText('vulnCatalogMeta', String(e)); }
    });
    const runBtn = _qs('vulnTestRunBtn');
    if (runBtn) runBtn.addEventListener('click', runVulnTest);
  });
</script>
{% endblock %}
