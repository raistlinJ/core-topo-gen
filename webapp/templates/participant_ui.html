{% extends 'layout.html' %}
{% block title %}Participant UI{% endblock %}
{% block active_page %}{% set active_page = 'participant_ui' %}{% endblock %}
{% block header_icon %}<i class="bi bi-person-video2 fs-4"></i>{% endblock %}
{% block header_title %}Participant Console{% endblock %}
{% block extra_head %}
{{ super() }}
<style>
  #participantUiRoot.participant-sidebar-hidden .participant-sidebar-col { display: none !important; }
  #participantUiRoot.participant-sidebar-hidden .participant-content-col {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .participant-sidebar-toggle-restore { display: none; }
  #participantUiRoot.participant-sidebar-hidden .participant-sidebar-toggle-restore {
    display: inline-flex !important;
  }
  .participant-mission-title { letter-spacing: 0.08em; text-transform: uppercase; }
  .participant-open-primary { letter-spacing: 0.12em; }

  /* Mirror core_details.html D3 graph styling */
  #topologyGraphCard .link.highlight { stroke: #ff5722 !important; stroke-width: 2.2px; }
  #topologyGraphCard .node.fade { opacity: 0.15; }
  #topologyGraphCard .node text { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  #topologyGraphCard .node rect { transition: stroke-dasharray 0.25s, width 0.25s, height 0.25s; }
  #topologyGraphCard .node:hover rect { stroke-width: 2; }
  #topologyGraphCard .node.switch-node rect { stroke: #ff9800; stroke-width: 2; }
  #topologyGraphCard .node.switch-node text.label { font-weight: 600; }
  #topologyGraphCard .btn-group .btn { white-space: nowrap; }
  #topologyGraph .graph-tooltip { position:absolute; pointer-events:none; background:rgba(33,33,33,0.92); color:#fff; font-size:11px; line-height:1.3; padding:6px 8px; border-radius:4px; box-shadow:0 2px 4px rgba(0,0,0,0.3); z-index:20; max-width:260px; text-align:left; }
  #topologyGraph .graph-tooltip.hidden { display:none; }
</style>
{% endblock %}
{% block content %}
{% set _user_role = (current_user.role.lower() if (current_user is defined and current_user.is_authenticated and current_user.role) else '') %}
{% set participant_hide_urls = _user_role in ['builder', 'participant'] %}
<div class="row g-3" id="participantUiRoot" data-active-norm="{{ participant_active_norm or '' }}" data-initial-href="{% if not participant_hide_urls %}{{ participant_url or '' }}{% endif %}">
  <div class="col-12 col-lg-4 participant-sidebar-col">
    <div class="card shadow-sm h-100 bg-dark text-light">
      <div class="card-body d-flex flex-column gap-3">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <h5 class="mb-0">{{ participant_scenarios_heading or 'Available Scenarios' }}</h5>
            {% if participant_scenarios_hint %}<small class="text-secondary">{{ participant_scenarios_hint }}</small>{% endif %}
          </div>
          {% if participant_scenarios %}
            <button class="btn btn-sm btn-outline-secondary" type="button" data-participant-toggle-sidebar aria-expanded="true">
              <span class="participant-collapse-label" data-label-expanded="Hide" data-label-collapsed="Show All Scenarios">Hide</span>
            </button>
          {% endif %}
        </div>
        {% if participant_scenarios %}
          <div class="collapse show flex-grow-1" id="participantScenarioListWrap">
            <div class="list-group list-group-flush overflow-auto" style="max-height: 65vh;">
              {% for scenario in participant_scenarios %}
                <div class="list-group-item bg-black text-light border-top border-secondary {% if loop.first %}border-top-0{% endif %} participant-scenario-item {% if scenario.active %}active border border-primary{% endif %} {% if not scenario.has_url %}opacity-75{% endif %}"
                     role="button" tabindex="0"
                     data-participant-scenario
                     data-scenario-norm="{{ scenario.norm|e }}"
                     data-scenario-display="{{ scenario.display|e }}"
                     data-scenario-url="{% if not participant_hide_urls %}{{ scenario.url|e }}{% endif %}"
                     data-scenario-has-url="{{ 1 if scenario.has_url else 0 }}">
                  <div class="d-flex flex-column gap-1">
                    <div class="d-flex flex-wrap align-items-center gap-2">
                      <span class="fw-semibold">{{ scenario.display }}</span>
                      {% if not scenario.has_url %}<span class="badge bg-warning text-dark">No Link</span>{% endif %}
                    </div>
                    {% if scenario.has_url %}
                      <div class="text-secondary small">
                        Participant console link available.
                      </div>
                    {% else %}
                      <div class="text-secondary small">Participant URL not configured yet.</div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="alert alert-secondary mb-0">{{ participant_scenarios_empty or 'No scenarios available.' }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-8 participant-content-col">
    <div class="card shadow-sm mb-0 bg-dark text-light">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary participant-sidebar-toggle-restore" type="button" data-participant-show-sidebar>Show All Scenarios</button>
            <div>
              <h5 class="mb-0 participant-mission-title font-monospace">Mission Briefing</h5>
              <small class="text-secondary" id="participantScenarioSubhead" data-default-text="Select a scenario to load its participant console below.">{% if participant_scenario_label %}Scenario: {{ participant_scenario_label }}{% else %}Select a scenario to load its participant console below.{% endif %}</small>
            </div>
          </div>
        </div>
        <div class="text-center mb-3">
          <button class="btn btn-lg btn-warning fw-bold text-uppercase font-monospace participant-open-primary px-4" type="button" id="participantOpenBtn" disabled>
            <i class="bi bi-box-arrow-up-right me-2"></i>Open Console
          </button>
        </div>
        <div class="card border bg-black mb-3" id="participantStatsCard" style="display:none;">
          <div class="card-body py-2">
            <div class="row g-2 small font-monospace">
              <div class="col-12 col-md-6">
                <div class="text-secondary">Session Status</div>
                <div>
                  <span class="badge bg-secondary text-uppercase" id="participantStatSessionStatus">-</span>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Session ID</div>
                <div class="fw-semibold text-white" id="participantStatSessionId">-</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Nearest Gateway Address</div>
                <div class="fw-semibold text-white" id="participantStatGateway">{{ participant_nearest_gateway or '-' }}</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Scenario Link</div>
                <div class="fw-semibold text-white" id="participantStatLinkConfigured">-</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Last opened (all users)</div>
                <div class="fw-semibold text-white" id="participantStatLastAll">-</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Open count (all users)</div>
                <div class="fw-semibold text-white" id="participantStatCountAll">0</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Last Execute</div>
                <div class="fw-semibold text-white" id="participantStatLastExecute">-</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-secondary">Last Execute Result</div>
                <div class="fw-semibold text-white" id="participantStatLastExecuteResult">-</div>
              </div>
              <div class="col-12 col-md-3">
                <div class="text-secondary">Nodes</div>
                <div class="fw-semibold text-white" id="participantStatNodes">-</div>
              </div>
              <div class="col-12 col-md-3">
                <div class="text-secondary">Routers</div>
                <div class="fw-semibold text-white" id="participantStatRouters">-</div>
              </div>
              <div class="col-12 col-md-3">
                <div class="text-secondary">Switches</div>
                <div class="fw-semibold text-white" id="participantStatSwitches">-</div>
              </div>
              <div class="col-12 col-md-3">
                <div class="text-secondary">Vulnerabilities</div>
                <div class="fw-semibold text-white" id="participantStatVulns">-</div>
              </div>
              <div class="col-12">
                <details id="participantSubnetworksDetails">
                  <summary class="text-secondary" id="participantSubnetworksSummary">Subnetworks (CIDR) (0)</summary>
                  <div class="mt-2">
                    <div class="row g-2" id="participantSubnetworksList" aria-label="Subnetworks"></div>
                  </div>
                </details>
              </div>
              <div class="col-12">
                <details id="participantVulnIpsDetails">
                  <summary class="text-secondary" id="participantVulnIpsSummary">Vulnerability IP addresses (0)</summary>
                  <div class="mt-2">
                    <div class="row g-2" id="participantVulnIpsList" aria-label="Vulnerability IP addresses"></div>
                  </div>
                </details>
              </div>
            </div>

            <div id="topologyGraphCard" style="display:none;">
              <hr class="border-secondary my-3" />
              <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div class="d-flex align-items-center gap-2">
                  <strong class="text-white">Graph View</strong>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="graphCollapseBtn" data-bs-toggle="collapse" data-bs-target="#topologyGraphCollapse" aria-expanded="false">Show</button>
                  </div>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="graphResetBtn" title="Reset zoom & layout">Reset</button>
                    <button type="button" class="btn btn-outline-secondary" id="graphClusterBtn" title="Cluster by type">Cluster: Off</button>
                  </div>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="graphExportSvgBtn" title="Download SVG">SVG</button>
                    <button type="button" class="btn btn-outline-secondary" id="graphExportPngBtn" title="Download PNG">PNG</button>
                  </div>
                </div>
                <div class="small text-secondary" id="graphStats"></div>
              </div>
              <div class="collapse" id="topologyGraphCollapse">
                <div class="pt-2">
                  <div id="topologyGraph" style="width:100%; height:460px; position:relative; border:1px solid #e0e0e0; border-radius:4px; background:#fafafa; overflow:hidden;"></div>
                  <div class="form-text mt-1">Drag nodes to reposition (they’ll stay pinned), scroll or pinch to zoom, and drag the background to pan. Hover highlights neighbors. Use Reset to clear zoom & unpin positions; Cluster groups by type; SVG/PNG export the view.</div>
                  <div class="text-secondary small mt-2" id="participantTopologyStatus"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
{{ super() }}
<script src="/static/vendor/d3.v7.min.js"></script>
<script src="{{ url_for('static', filename='core_graph.js') }}"></script>
<script>
(function(){
  if(typeof window === 'undefined') return;
  const root = document.getElementById('participantUiRoot');
  if(!root) return;
  const subhead = document.getElementById('participantScenarioSubhead');
  const openBtn = document.getElementById('participantOpenBtn');
  const statsCard = document.getElementById('participantStatsCard');
  const statGateway = document.getElementById('participantStatGateway');
  const statLinkConfigured = document.getElementById('participantStatLinkConfigured');
  const statLastAll = document.getElementById('participantStatLastAll');
  const statCountAll = document.getElementById('participantStatCountAll');
  const statSessionStatus = document.getElementById('participantStatSessionStatus');
  const statSessionId = document.getElementById('participantStatSessionId');
  const statLastExecute = document.getElementById('participantStatLastExecute');
  const statLastExecuteResult = document.getElementById('participantStatLastExecuteResult');
  const statNodes = document.getElementById('participantStatNodes');
  const statRouters = document.getElementById('participantStatRouters');
  const statSwitches = document.getElementById('participantStatSwitches');
  const statVulns = document.getElementById('participantStatVulns');
  const subnetworksDetails = document.getElementById('participantSubnetworksDetails');
  const subnetworksSummary = document.getElementById('participantSubnetworksSummary');
  const subnetworksList = document.getElementById('participantSubnetworksList');
  const vulnIpsDetails = document.getElementById('participantVulnIpsDetails');
  const vulnIpsSummary = document.getElementById('participantVulnIpsSummary');
  const vulnIpsList = document.getElementById('participantVulnIpsList');
  const topologyGraphCard = document.getElementById('topologyGraphCard');
  const topologyGraph = document.getElementById('topologyGraph');
  const topologyStatus = document.getElementById('participantTopologyStatus');
  const graphCollapseBtn = document.getElementById('graphCollapseBtn');
  const topologyGraphCollapse = document.getElementById('topologyGraphCollapse');
  const scenarioItems = Array.from(document.querySelectorAll('[data-participant-scenario]'));
  const toggleSidebarBtn = document.querySelector('[data-participant-toggle-sidebar]');
  const showSidebarBtn = document.querySelector('[data-participant-show-sidebar]');
  const collapseLabel = toggleSidebarBtn ? toggleSidebarBtn.querySelector('.participant-collapse-label') : null;

  let currentNorm = root.getAttribute('data-active-norm') || '';
  let currentHasUrl = false;
  let currentHref = '';
  let currentSessionRunning = false;

  const openRedirectHref = (norm) => {
    if(!norm) return '/participant-ui/open';
    return `/participant-ui/open?scenario=${encodeURIComponent(norm)}`;
  };

  const updateSubhead = (display) => {
    if(!subhead) return;
    const base = subhead.getAttribute('data-default-text') || '';
    subhead.textContent = display ? `Scenario: ${display}` : base;
  };

  const updateOpenButton = (href) => {
    if(!openBtn) return;
    currentHref = href || '';
    openBtn.disabled = !(currentHref && currentHasUrl && currentSessionRunning === true);
    if(statsCard){
      statsCard.style.display = currentNorm ? '' : 'none';
    }
  };

  const fmtTs = (ts) => {
    if(!ts) return 'Never';
    try {
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return String(ts);
      return d.toLocaleString();
    } catch(e){
      return String(ts);
    }
  };

  const renderSubnetworks = (items) => {
    if(!subnetworksList || !subnetworksSummary) return;
    const names = Array.isArray(items) ? items.map(v => String(v || '').trim()).filter(Boolean) : [];
    const ipToInt = (ip) => {
      const parts = String(ip || '').trim().split('.');
      if(parts.length !== 4) return null;
      const nums = parts.map(p => Number(p));
      if(nums.some(n => !Number.isFinite(n) || n < 0 || n > 255)) return null;
      return ((nums[0] << 24) >>> 0) + (nums[1] << 16) + (nums[2] << 8) + nums[3];
    };
    const parseCidr = (cidr) => {
      const text = String(cidr || '').trim();
      const [ip, suffix] = text.split('/', 2);
      const ipInt = ipToInt(ip);
      const prefix = suffix !== undefined ? Number(suffix) : null;
      return { text, ip, ipInt, prefix: Number.isFinite(prefix) ? prefix : null };
    };
    const sorted = names
      .map(parseCidr)
      .sort((a, b) => {
        if(a.ipInt !== null && b.ipInt !== null) {
          if(a.ipInt !== b.ipInt) return a.ipInt - b.ipInt;
          const ap = a.prefix === null ? 999 : a.prefix;
          const bp = b.prefix === null ? 999 : b.prefix;
          return ap - bp;
        }
        return a.text.localeCompare(b.text);
      });
    subnetworksSummary.textContent = `Subnetworks (CIDR) (${names.length})`;
    subnetworksList.innerHTML = '';
    sorted.forEach((row) => {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-4 col-lg-3';
      const box = document.createElement('div');
      box.className = 'border border-secondary rounded px-2 py-1 small font-monospace text-white';
      box.textContent = row.text;
      col.appendChild(box);
      subnetworksList.appendChild(col);
    });
    if(subnetworksDetails){
      subnetworksDetails.style.display = '';
      if(names.length === 0){
        subnetworksDetails.open = false;
      }
    }
  };

  const renderVulnerabilityIps = (items) => {
    if(!vulnIpsList || !vulnIpsSummary) return;
    const names = Array.isArray(items) ? items.map(v => String(v || '').trim()).filter(Boolean) : [];
    const ipToInt = (ip) => {
      const parts = String(ip || '').trim().split('.');
      if(parts.length !== 4) return null;
      const nums = parts.map(p => Number(p));
      if(nums.some(n => !Number.isFinite(n) || n < 0 || n > 255)) return null;
      return ((nums[0] << 24) >>> 0) + (nums[1] << 16) + (nums[2] << 8) + nums[3];
    };
    const uniq = Array.from(new Set(names));
    const sorted = uniq
      .map(ip => ({ ip, ipInt: ipToInt(ip) }))
      .sort((a, b) => {
        if(a.ipInt !== null && b.ipInt !== null) return a.ipInt - b.ipInt;
        if(a.ipInt !== null) return -1;
        if(b.ipInt !== null) return 1;
        return a.ip.localeCompare(b.ip);
      });
    vulnIpsSummary.textContent = `Vulnerability IP addresses (${uniq.length})`;
    vulnIpsList.innerHTML = '';
    sorted.forEach((row) => {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-4 col-lg-3';
      const box = document.createElement('div');
      box.className = 'border border-secondary rounded px-2 py-1 small font-monospace text-white';
      box.textContent = row.ip;
      col.appendChild(box);
      vulnIpsList.appendChild(col);
    });
    if(vulnIpsDetails){
      vulnIpsDetails.style.display = '';
      if(uniq.length === 0){
        vulnIpsDetails.open = false;
      }
    }
  };

  const fetchScenarioDetails = async (norm) => {
    try {
      const url = norm ? `/participant-ui/details?scenario=${encodeURIComponent(norm)}` : '/participant-ui/details';
      const resp = await fetch(url, { credentials: 'same-origin' });
      if(!resp.ok) return null;
      const payload = await resp.json();
      if(!payload || !payload.ok) return null;
      return payload;
    } catch(e){
      return null;
    }
  };

  const fetchScenarioTopology = async (norm) => {
    try {
      const url = norm ? `/participant-ui/topology?scenario=${encodeURIComponent(norm)}` : '/participant-ui/topology';
      const resp = await fetch(url, { credentials: 'same-origin', cache: 'no-store' });
      if(!resp.ok) return null;
      const payload = await resp.json();
      if(!payload || !payload.ok) return null;
      return payload;
    } catch(e){
      return null;
    }
  };

  // Defensive: expose helpers on window so runtime calls won't fail if the
  // surrounding script is accidentally re-scoped by a formatter/edit.
  try {
    window.fetchScenarioDetails = fetchScenarioDetails;
    window.fetchScenarioTopology = fetchScenarioTopology;
  } catch(e) {}

  const _topologyGraphScaffoldHtml = () => {
    return `
      <div class="position-absolute top-50 start-50 translate-middle text-muted" id="graphLoading">Rendering graph...</div>
      <div class="position-absolute top-50 start-50 translate-middle text-muted d-none" id="graphNoData" style="max-width:70%; text-align:center;">
        <div class="mb-2">No device nodes were parsed from this scenario yet.</div>
        <div class="small text-muted">Links detected: <span id="graphNoDataLinksCount">0</span>.</div>
      </div>
      <div class="position-absolute top-0 end-0 m-2 p-2 bg-white border rounded shadow-sm small" id="graphLegend" style="max-width:220px;">
        <div class="fw-semibold mb-1">Legend</div>
        <div id="graphLegendItems" class="d-flex flex-wrap gap-2"></div>
        <div class="mt-1 text-muted" style="font-size:0.7rem;">Circle size = services count</div>
      </div>
      <div id="graphMiniMap" class="position-absolute bg-white border rounded shadow-sm" style="bottom:8px; right:8px; width:160px; height:120px; overflow:hidden; cursor:grab;">
        <svg width="160" height="120"></svg>
      </div>
      <div id="graphTooltip" class="graph-tooltip hidden"></div>
    `;
  };

  let _participantGraphInstance = null;

  // Mirror the Preview tab graph view: annotate topology nodes with
  // sequence_index based on saved flow chain so Roman numerals can render.
  const _annotateSequenceNodesFromFlow = (nodes, flow) => {
    try {
      const list = Array.isArray(nodes) ? nodes : [];
      if(!list.length) return;
      const chain = (flow && Array.isArray(flow.chain)) ? flow.chain : null;
      if(!chain || !chain.length) return;

      const nodeById = new Map();
      list.forEach(n => { if(n && n.id !== undefined && n.id !== null) nodeById.set(String(n.id), n); });
      const chainLen = chain.length;

      const resolveNodeForChainEntry = (entry) => {
        let raw = entry;
        if(entry && typeof entry === 'object'){
          raw = entry.id ?? entry.node_id ?? entry.nodeId ?? entry.host_id ?? entry.hostId ?? entry;
        }
        if(raw === undefined || raw === null) return null;
        const key = String(raw);
        if(nodeById.has(key)) return nodeById.get(key);
        const m = key.match(/(\d+)/);
        if(m && nodeById.has(m[1])) return nodeById.get(m[1]);
        const asNum = Number(key);
        if(Number.isFinite(asNum) && nodeById.has(String(asNum))) return nodeById.get(String(asNum));
        return null;
      };

      chain.forEach((entry, idx) => {
        const target = resolveNodeForChainEntry(entry);
        if(!target) return;
        target.isSequence = true;
        target.sequence_index = idx + 1;
        target.sequence_chain_len = chainLen;
      });
    } catch(e) {}
  };

  const renderTopologyGraph = (payload) => {
    if(!topologyGraphCard || !topologyGraph) return;
    if(!currentNorm){
      topologyGraphCard.style.display = 'none';
      return;
    }
    topologyGraphCard.style.display = '';

    const nodesRaw = Array.isArray(payload && payload.nodes) ? payload.nodes : [];
    const linksRaw = Array.isArray(payload && payload.links) ? payload.links : [];
    // Keep this quiet; backend status can include filenames.
    if(topologyStatus) topologyStatus.textContent = '';

    if(!window.d3 || !window.CoreGraph){
      topologyGraph.innerHTML = `<div class="p-3 text-muted small">Graph libraries not loaded (d3/CoreGraph).</div>`;
      return;
    }

    topologyGraph.innerHTML = _topologyGraphScaffoldHtml();

    const mappedNodes = nodesRaw
      .filter(n => n && n.id !== null && n.id !== undefined)
      .map(n => {
        const idVal = String(n.id);
        const nameVal = (n.name !== null && n.name !== undefined) ? String(n.name) : idVal;
        const typeVal = (n.type !== null && n.type !== undefined) ? String(n.type) : 'node';
        const servicesVal = Array.isArray(n.services) ? n.services : [];
        const ifacesVal = Array.isArray(n.interfaces) ? n.interfaces : [];
        const ipv4sVal = Array.isArray(n.ipv4s) ? n.ipv4s : [];
        const subnetsVal = Array.isArray(n.subnets) ? n.subnets : [];
        return {
          id: idVal,
          name: nameVal || idVal,
          type: typeVal || 'node',
          services: servicesVal,
          interfaces: ifacesVal,
          ipv4s: ipv4sVal,
          subnets: subnetsVal,
          hasVuln: !!n.is_vulnerability,
        };
      });

    const mappedLinks = linksRaw
      .map(l => {
        const n1 = (l && (l.node1 ?? l.source)) !== null && (l && (l.node1 ?? l.source)) !== undefined ? String(l.node1 ?? l.source) : '';
        const n2 = (l && (l.node2 ?? l.target)) !== null && (l && (l.node2 ?? l.target)) !== undefined ? String(l.node2 ?? l.target) : '';
        const n1Name = (l && l.node1_name) !== null && (l && l.node1_name) !== undefined ? String(l.node1_name) : '';
        const n2Name = (l && l.node2_name) !== null && (l && l.node2_name) !== undefined ? String(l.node2_name) : '';
        return { node1: n1, node2: n2, node1_name: n1Name, node2_name: n2Name };
      })
      .filter(l => l.node1 && l.node2 && l.node1 !== l.node2);

    // Add sequencing info (if present) before rendering.
    try { _annotateSequenceNodesFromFlow(mappedNodes, payload && payload.flow); } catch(e) {}

    // Lightweight diagnostics (mirrors Details page graph stats area)
    try {
      const statsEl = document.getElementById('graphStats');
      if(statsEl){
        const idIndex = new Map();
        mappedNodes.forEach((n,i)=>{ idIndex.set(String(n.id), i); idIndex.set(String(n.name), i); });
        const resolved = mappedLinks.filter(l => {
          const s = idIndex.get(String(l.node1)) ?? idIndex.get(String(l.node1_name));
          const t = idIndex.get(String(l.node2)) ?? idIndex.get(String(l.node2_name));
          return s !== undefined && t !== undefined && s !== t;
        }).length;
        statsEl.textContent = `Nodes: ${mappedNodes.length} • Links: ${mappedLinks.length} • Resolved: ${resolved}`;
      }
    } catch(e) {}

    const noDataEl = document.getElementById('graphNoData');
    const loadingEl = document.getElementById('graphLoading');

    if(mappedNodes.length === 0){
      if(loadingEl) loadingEl.remove();
      if(noDataEl){
        noDataEl.classList.remove('d-none');
        const lc = document.getElementById('graphNoDataLinksCount');
        if(lc) lc.textContent = String(mappedLinks.length);
      }
      return;
    }

    if(noDataEl) noDataEl.classList.add('d-none');
    try {
      _participantGraphInstance = window.CoreGraph.init({
        containerSelector: '#topologyGraph',
        nodes: mappedNodes,
        linksRaw: mappedLinks,
        xmlPath: `participant_${currentNorm}`
      });
    } finally {
      const loading2 = document.getElementById('graphLoading');
      if(loading2) loading2.remove();
    }
  };

  const renderScenarioDetails = (payload) => {
    const gw = payload && typeof payload.gateway === 'string' ? payload.gateway : '';
    if(statGateway) statGateway.textContent = gw || '-';

    const openStats = (payload && payload.open_stats) || {};
    if(statLastAll) statLastAll.textContent = fmtTs(openStats.last_open_ts || '');
    if(statCountAll) statCountAll.textContent = String(Number(openStats.open_count) || 0);

    const scen = (payload && payload.scenario) || {};
    if(statLinkConfigured) statLinkConfigured.textContent = scen.participant_link_configured ? 'Configured' : 'Missing';

    const sess = (payload && payload.session) || {};
    currentSessionRunning = (sess.running === true);
    if(statSessionStatus){
      statSessionStatus.classList.remove('bg-success', 'bg-danger', 'bg-secondary');
      if(sess.running === true) {
        statSessionStatus.textContent = sess.state ? `Running (${sess.state})` : 'Running';
        statSessionStatus.classList.add('bg-success');
      }
      else if(sess.running === false) {
        statSessionStatus.textContent = 'Not running';
        statSessionStatus.classList.add('bg-secondary');
      }
      else {
        statSessionStatus.textContent = 'Unknown';
        statSessionStatus.classList.add('bg-secondary');
      }
    }
    if(statSessionId) statSessionId.textContent = (sess.session_id !== null && sess.session_id !== undefined) ? String(sess.session_id) : '-';

    // Session status affects Open Console gating.
    updateOpenButton(currentHref);

    const exec = (payload && payload.execute) || {};
    if(statLastExecute) statLastExecute.textContent = fmtTs(exec.last_execute_ts || '');
    if(statLastExecuteResult){
      if(exec.ok === true) {
        statLastExecuteResult.textContent = 'Success';
      }
      else if(exec.ok === false) {
        statLastExecuteResult.textContent = 'Failure';
      }
      else {
        statLastExecuteResult.textContent = '-';
      }
    }

    const counts = (payload && payload.counts) || {};
    if(statNodes) statNodes.textContent = (counts.nodes !== null && counts.nodes !== undefined) ? String(counts.nodes) : '-';
    if(statRouters) statRouters.textContent = (counts.routers !== null && counts.routers !== undefined) ? String(counts.routers) : '-';
    if(statSwitches) statSwitches.textContent = (counts.switches !== null && counts.switches !== undefined) ? String(counts.switches) : '-';
    if(statVulns) statVulns.textContent = (counts.vulnerabilities !== null && counts.vulnerabilities !== undefined) ? String(counts.vulnerabilities) : '-';

    renderSubnetworks(payload && payload.subnetworks);
    renderVulnerabilityIps(payload && payload.vulnerability_ips);
  };

  const refreshStats = async () => {
    const details = await fetchScenarioDetails(currentNorm);
    if(details) renderScenarioDetails(details);

    const topo = await fetchScenarioTopology(currentNorm);
    if(topo) {
      renderTopologyGraph(topo);
    } else {
      if(topologyGraphCard && currentNorm) topologyGraphCard.style.display = '';
      if(topologyGraph && currentNorm) topologyGraph.innerHTML = `<div class="p-3 text-muted small">Loading topology…</div>`;
      if(topologyStatus && currentNorm) topologyStatus.textContent = '';
    }
  };

  try { window.participantRefreshStats = refreshStats; } catch(e) {}

  if(openBtn && !openBtn.dataset.bound){
    openBtn.dataset.bound = '1';
    openBtn.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      if(!(currentHref && currentHasUrl && currentSessionRunning === true)) return;
      try {
        fetch('/participant-ui/record-open', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ scenario_norm: currentNorm, href: currentHref })
        }).then(()=> refreshStats()).catch(()=>{});
      } catch(e){}
      try { window.open(currentHref, '_blank', 'noopener'); } catch(e) {}
    });
  }

  const highlightScenario = (norm) => {
    scenarioItems.forEach(item => {
      const isActive = norm && item.getAttribute('data-scenario-norm') === norm;
      item.classList.toggle('active', !!isActive);
      item.classList.toggle('border', !!isActive);
      item.classList.toggle('border-primary', !!isActive);
    });
  };

  const persistSelectionInQuery = (norm) => {
    try {
      const urlObj = new URL(window.location.href);
      if(norm) {
        urlObj.searchParams.set('scenario', norm);
      } else {
        urlObj.searchParams.delete('scenario');
      }
      window.history.replaceState({}, '', `${urlObj.pathname}${urlObj.search}${urlObj.hash}`);
    } catch(err) {
      /* ignore */
    }
  };

  const persistSelectionInLocalStorage = (norm) => {
    try {
      if(!norm) return;
      window.localStorage.setItem('participant_ui_last_scenario_norm', String(norm));
    } catch(err) {
      /* ignore */
    }
  };

  const applyScenarioSelection = (norm, display, hasUrl) => {
    currentNorm = norm || '';
    currentHasUrl = !!hasUrl;
    highlightScenario(currentNorm);
    updateSubhead(display || '');
    const resolvedHref = currentNorm ? openRedirectHref(currentNorm) : '';
    updateOpenButton(resolvedHref);
    persistSelectionInQuery(currentNorm);
    persistSelectionInLocalStorage(currentNorm);
    refreshStats();
  };

  const activateFromElement = (item) => {
    if(!item) return;
    const norm = item.getAttribute('data-scenario-norm') || '';
    const display = item.getAttribute('data-scenario-display') || '';
    const hasUrl = item.getAttribute('data-scenario-has-url') === '1';
    applyScenarioSelection(norm, display, hasUrl);
  };

  scenarioItems.forEach(item => {
    item.addEventListener('click', () => activateFromElement(item));
    item.addEventListener('keydown', (evt) => {
      if(evt.key === 'Enter' || evt.key === ' '){
        evt.preventDefault();
        activateFromElement(item);
      }
    });
  });

  let storedNorm = '';
  try { storedNorm = window.localStorage.getItem('participant_ui_last_scenario_norm') || ''; } catch(e) { storedNorm = ''; }

  const initialTarget = scenarioItems.find(el => storedNorm && el.getAttribute('data-scenario-norm') === storedNorm)
    || scenarioItems.find(el => el.getAttribute('data-scenario-norm') === currentNorm)
    || scenarioItems[0];
  if(initialTarget){
    activateFromElement(initialTarget);
  } else {
    updateSubhead('');
    currentHasUrl = false;
    updateOpenButton('');
    persistSelectionInQuery('');
    refreshStats();
  }

  window.addEventListener('storage', (evt) => {
    if(evt && evt.key && evt.key !== 'coretg_editor_state') return;
    const nextHref = currentNorm ? openRedirectHref(currentNorm) : '';
    updateOpenButton(nextHref);
    refreshStats();
  });

  const applySidebarHidden = (hidden) => {
    if(!root) return;
    root.classList.toggle('participant-sidebar-hidden', hidden);
    if(toggleSidebarBtn){
      toggleSidebarBtn.setAttribute('aria-expanded', hidden ? 'false' : 'true');
    }
    if(collapseLabel){
      const expandedText = collapseLabel.getAttribute('data-label-expanded') || 'Hide list';
      const collapsedText = collapseLabel.getAttribute('data-label-collapsed') || 'Show list';
      collapseLabel.textContent = hidden ? collapsedText : expandedText;
    }
  };
  if(toggleSidebarBtn){
    toggleSidebarBtn.addEventListener('click', (evt) => {
      evt.preventDefault();
      const currentlyHidden = root.classList.contains('participant-sidebar-hidden');
      applySidebarHidden(!currentlyHidden);
    });
    // Default to hidden to keep the center action prominent.
    applySidebarHidden(true);
  }
  if(showSidebarBtn){
    showSidebarBtn.addEventListener('click', (evt) => {
      evt.preventDefault();
      applySidebarHidden(false);
    });
  }

  // Graph collapse button label + layout nudge on expand.
  try {
    if(topologyGraphCollapse && graphCollapseBtn){
      topologyGraphCollapse.addEventListener('hidden.bs.collapse', ()=>{ graphCollapseBtn.textContent = 'Show'; graphCollapseBtn.setAttribute('aria-expanded','false'); });
      topologyGraphCollapse.addEventListener('shown.bs.collapse', ()=>{
        graphCollapseBtn.textContent = 'Hide'; graphCollapseBtn.setAttribute('aria-expanded','true');
        try { setTimeout(()=>{ _participantGraphInstance?.simulation?.alpha(0.15).restart(); }, 50); } catch(e) {}
      });
    }
  } catch(e) {}
})();
</script>
{% endblock %}
