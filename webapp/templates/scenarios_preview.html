{% extends "layout.html" %}

{% block title %}Preview{% endblock %}
{% block active_page %}{% set active_page='scenarios' %}{% endblock %}
{% block header_icon %}<i class="bi bi-eye fs-4"></i>{% endblock %}
{% block header_title %}Preview{% endblock %}

{% block extra_head %}
<style>
  body {
    padding-bottom: 0;
  }

  #previewLayoutRow {
    min-height: calc(100vh - 200px);
  }

  #previewLayoutRow>[class*='col-'] {
    min-width: 0;
  }

  @media (max-width: 992px) {
    #previewLayoutRow {
      min-height: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
{% set scenario_tab = (active_scenario or scenario_tab or request.args.get('scenario','')) %}
{% set scenarios_active_tab = 'preview' %}
{% include 'partials/scenarios_tabs.html' with context %}

<div class="container-fluid mt-3 d-flex flex-column" id="previewPageWrap">
  <div class="row g-3 flex-grow-1 align-items-stretch" id="previewLayoutRow">
    <div class="col-12 col-lg-3 d-flex">
      <div class="card shadow-sm mb-3 flex-fill d-flex flex-column">
        <div class="card-header d-flex justify-content-between align-items-center flex-nowrap gap-2">
          <span class="fw-bold">Scenarios</span>
          <div class="btn-toolbar gap-1 align-items-center flex-nowrap">

            <button class="btn btn-sm btn-outline-secondary {% if not active_scenario %}d-none{% endif %}"
              id="previewScenarioFilterClear" type="button" title="Clear">Clear</button>
          </div>
        </div>
        <div class="list-group list-group-flush flex-grow-1 overflow-auto" id="previewScenarioList"
          style="min-height:0;">
          {% if scenarios %}
          {% for s in scenarios %}
          <button type="button"
            class="list-group-item list-group-item-action py-1 {% if active_scenario and active_scenario==s %}active bg-primary text-white{% endif %}"
            data-scen-name="{{ s }}" data-xml-path="{{ (scenario_xml_by_name or {}).get(s, '') }}">
            <div class="d-flex align-items-center">
              <span class="flex-grow-1 text-truncate">{{ s }}</span>

            </div>
          </button>
          {% endfor %}
          {% else %}
          <div class="p-3 text-muted small">No scenarios yet</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-9 d-flex">
      <div class="flex-fill d-flex flex-column">
        <div class="small text-muted mb-2">Generating a full preview can take a moment.</div>
        <iframe id="scenariosPreviewFrame" name="scenariosPreviewFrame" title="Full preview"
          style="width: 100%; height: calc(100vh - 260px); border: 1px solid var(--bs-border-color); border-radius: .25rem; background: white;"></iframe>

        <form id="scenariosPreviewLoadForm" method="post" action="{{ url_for('plan_full_preview_page', embed=1) }}"
          target="scenariosPreviewFrame" class="d-none">
          <input type="hidden" name="xml_path" id="scenariosPreviewLoadXmlPath"
            value="{{ preview_xml_path or request.args.get('xml_path','') }}">
          <input type="hidden" name="scenario" id="scenariosPreviewLoadScenario" value="{{ scenario_tab }}">
          <input type="hidden" name="seed" id="scenariosPreviewLoadSeed" value="">
          <input type="hidden" name="preview_plan" id="scenariosPreviewLoadPreviewPlan" value="">
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal" tabindex="-1" id="scenariosPreviewLoadingModal" aria-hidden="true" data-bs-backdrop="static"
  data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body d-flex align-items-center gap-3">
        <div class="spinner-border" role="status" aria-label="Loading"></div>
        <div>
          <div class="fw-semibold">Loading preview…</div>
          <div class="small text-muted">Rendering preview page.</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_container %}
{{ super() }}
{% set xml_preview_enabled = True %}
{% set xml_preview_text = xml_preview | default('') %}
{% include 'partials/dock.html' %}
<script>
  (function () {




    let previewLoadingHidden = false;
    function showLoading() {
      previewLoadingHidden = false;
      try {
        const el = document.getElementById('scenariosPreviewLoadingModal');
        if (!el) return null;
        try { if (el.style) el.style.display = 'block'; } catch (e) { }
        try { el.removeAttribute('inert'); } catch (e) { }
        try { el.style.display = 'block'; } catch (e) { }
        try { el.classList.add('show'); } catch (e) { }
        try { document.body.classList.add('modal-open'); } catch (e) { }
        if (window.bootstrap && window.bootstrap.Modal) {
          try {
            const modal = window.bootstrap.Modal.getOrCreateInstance(el, { backdrop: 'static', keyboard: false });
            modal.show();
            return modal;
          } catch (e) { }
        }
        return null;
      } catch (e) { return null; }
    }

    function forceHidePreviewLoading(el) {
      try {
        el.classList.remove('show');
        el.style.display = 'none';
        el.setAttribute('aria-hidden', 'true');
        el.removeAttribute('aria-modal');
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('paddingRight');
        document.body.style.removeProperty('overflow');
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach((bd) => bd.parentNode && bd.parentNode.removeChild(bd));
      } catch (e) { }
    }

    function hideLoading(reason) {
      if (previewLoadingHidden) return;
      previewLoadingHidden = true;
      try {
        const el = document.getElementById('scenariosPreviewLoadingModal');
        if (!el) return;
        try {
          const active = document.activeElement;
          if (active && el.contains(active) && typeof active.blur === 'function') {
            active.blur();
          }
        } catch (e) { }
        if (window.bootstrap && window.bootstrap.Modal) {
          try {
            const modal = window.bootstrap.Modal.getOrCreateInstance(el);
            modal.hide();
            try { modal.dispose(); } catch (e) { }
          } catch (e) { }
        }
        forceHidePreviewLoading(el);
        // If bootstrap transitions re-show the modal, force-hide again on next tick.
        setTimeout(() => {
          try {
            if (el.classList.contains('show') || el.style.display !== 'none') {
              forceHidePreviewLoading(el);
            }
          } catch (e) { }
        }, 50);
        try { console.debug('[preview] hide loading', reason || 'unknown'); } catch (e) { }
      } catch (e) { }
    }

    try {
      window.addEventListener('message', (ev) => {
        try {
          if (ev.origin !== window.location.origin) return;
          const data = ev && ev.data ? ev.data : null;
          if (data && data.type === 'full-preview-ready') {
            try { console.debug('[preview] message full-preview-ready'); } catch (e) { }
            hideLoading('postMessage');
          }
        } catch (e) { }
      });
    } catch (e) { }

    async function loadPreview() {
      const startTs = Date.now();
      const params = new URLSearchParams(window.location.search || '');
      // Prefer server-validated hidden inputs over query params. If a stale/invalid
      // xml_path is present in the URL, the backend will intentionally clear it and
      // provide a safe fallback in the hidden field.
      let xmlPath = (document.getElementById('scenariosPreviewLoadXmlPath')?.value || params.get('xml_path') || '').trim();
      const scenario = (params.get('scenario') || document.getElementById('scenariosPreviewLoadScenario')?.value || '').trim();

      const frame = document.getElementById('scenariosPreviewFrame');
      const form = document.getElementById('scenariosPreviewLoadForm');
      const inXml = document.getElementById('scenariosPreviewLoadXmlPath');
      const inSc = document.getElementById('scenariosPreviewLoadScenario');
      const inSeed = document.getElementById('scenariosPreviewLoadSeed');
      const inPlan = document.getElementById('scenariosPreviewLoadPreviewPlan');

      if (inXml) inXml.value = xmlPath;
      if (inSc) inSc.value = scenario;

      if (!xmlPath && scenario) {
        try {
          const latestResp = await fetch('/api/scenario/latest_xml?scenario=' + encodeURIComponent(scenario), { credentials: 'same-origin' });
          const latestData = await latestResp.json();
          if (latestResp.ok && latestData && latestData.ok && latestData.xml_path) {
            xmlPath = String(latestData.xml_path || '').trim();
            if (inXml) inXml.value = xmlPath;
            try {
              if (typeof window.coretgSetLatestXmlPathForScenario === 'function') {
                window.coretgSetLatestXmlPathForScenario(scenario, xmlPath);
              }
            } catch (e) { }
          }
        } catch (e) { }
      }

      // Use a stable per-scenario seed unless the user explicitly changes it on the embedded page.
      try {
        if (scenario && typeof window.coretgEnsureSeedForScenario === 'function') {
          const seed = window.coretgEnsureSeedForScenario(scenario);
          if (inSeed && seed !== null && seed !== undefined) inSeed.value = String(seed);
        }
      } catch (e) { }

      // XML is the source of truth for preview. Ignore preview_plan paths that redirect.
      const useXmlPreview = !!xmlPath;
      if (!useXmlPreview) {
        if (frame) {
          frame.srcdoc = '<div style="font-family: system-ui; padding: 16px; color: #6c757d;">Preview requires a saved XML. Use Topology → Save XML first.</div>';
        }
        return;
      }

      try {
        if (inPlan) inPlan.value = '';
        form.action = '{{ url_for('plan_full_preview_from_xml', embed=1) }}';
      } catch (e) { }

      try {
        console.debug('[preview] submit', { xmlPath, scenario, action: form && form.action });
      } catch (e) { }

      const modal = showLoading();
      if (frame) {
        // Clear previous content for immediate feedback.
        try { frame.srcdoc = '<div style="font-family: system-ui; padding: 16px; color: #6c757d;">Loading preview…</div>'; } catch (e) { }
        frame.addEventListener('load', async () => {
          try { modal && modal.hide(); } catch (e) { }
          try { hideLoading('iframe-load'); } catch (e) { }
          try {
            const doc = frame.contentDocument || frame.contentWindow?.document;
            const title = doc && doc.title ? doc.title : '(no title)';
            const bodyText = doc && doc.body ? doc.body.textContent || '' : '';
            console.debug('[preview] iframe loaded', { title, bodySnippet: bodyText.slice(0, 200), ms: Date.now() - startTs });
          } catch (e) {
            console.debug('[preview] iframe loaded (content unavailable)');
          }
        }, { once: true });
      }

      // Poll readyState to avoid waiting on load when content is already interactive.
      const pollStart = Date.now();
      const pollTimer = setInterval(() => {
        if (!frame) return;
        try {
          const doc = frame.contentDocument || frame.contentWindow?.document;
          const rs = doc && doc.readyState ? doc.readyState : '';
          if (rs === 'interactive' || rs === 'complete') {
            clearInterval(pollTimer);
            hideLoading('readyState-' + rs);
            try { console.debug('[preview] readyState', rs, 'ms', Date.now() - startTs); } catch (e) { }
          }
        } catch (e) { }
        if (Date.now() - pollStart > 8000) {
          clearInterval(pollTimer);
        }
      }, 100);

      // Fallback: auto-hide if the iframe load event never fires.
      setTimeout(() => {
        try { hideLoading('timeout'); } catch (e) { }
      }, 20000);

      try { form && form.submit(); } catch (e) { try { modal && modal.hide(); } catch (_e) { } try { hideLoading('submit-error'); } catch (_e) { } }
    }

    document.addEventListener('DOMContentLoaded', () => {
      try {
        const params = new URLSearchParams(window.location.search || '');
        const scenario = (params.get('scenario') || document.getElementById('scenariosPreviewLoadScenario')?.value || '').trim();
        if (scenario && typeof window.coretgSetActiveScenarioForNav === 'function') {
          window.coretgSetActiveScenarioForNav(scenario);
        }
      } catch (e) { }



      // Shared Scenarios Execute button: hand off to Topology execution flow.
      try {
        document.getElementById('scenariosExecuteBtn')?.addEventListener('click', (ev) => {
          try {
            ev.preventDefault();
            const params = new URLSearchParams(window.location.search || '');
            const xmlPath = (document.getElementById('scenariosPreviewLoadXmlPath')?.value || params.get('xml_path') || '').trim();
            const scenario = (params.get('scenario') || document.getElementById('scenariosPreviewLoadScenario')?.value || '').trim();
            try {
              if (scenario && typeof window.coretgSetActiveScenarioForNav === 'function') {
                window.coretgSetActiveScenarioForNav(scenario);
              }
            } catch (e) { }
            if (!xmlPath) {
              alert('Save XML first to execute.');
              return;
            }
            const base = '/';
            const url = base + '?xml_path=' + encodeURIComponent(xmlPath)
              + (scenario ? ('&scenario=' + encodeURIComponent(scenario)) : '')
              + '&auto_execute=1';
            window.location.href = url;
          } catch (e) { }
        });
      } catch (e) { }

      // Sidebar scenario list: navigate to the selected scenario + known xml_path.
      try {
        const listEl = document.getElementById('previewScenarioList');
        const clearBtn = document.getElementById('previewScenarioFilterClear');
        const scenarios = {{ (scenarios or[]) | tojson
  }};
  const xmlByName = {{ (scenario_xml_by_name or { })| tojson }};
  const baseUrl = '/scenarios/preview';
  function goScenario(name) {
    const scen = (name || '').toString().trim();
    try {
      if (scen && typeof window.coretgSetActiveScenarioForNav === 'function') {
        window.coretgSetActiveScenarioForNav(scen);
      }
    } catch (e) { }
    let xml = (xmlByName && scen && xmlByName[scen]) ? String(xmlByName[scen]) : '';
    try {
      if (scen && typeof window.coretgGetLatestXmlPathForScenario === 'function') {
        const latest = (window.coretgGetLatestXmlPathForScenario(scen) || '').toString().trim();
        if (latest) xml = latest;
      }
    } catch (e) { }
    if (!xml) {
      alert('No saved XML found for that scenario.');
      return;
    }
    window.location.href = baseUrl + '?xml_path=' + encodeURIComponent(xml) + '&scenario=' + encodeURIComponent(scen);
  }
  if (listEl) {
    listEl.addEventListener('click', (ev) => {
      const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-scen-name]') : null;
      if (!btn) return;
      const scen = btn.getAttribute('data-scen-name') || '';
      goScenario(scen);
    });
  }
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (Array.isArray(scenarios) && scenarios.length) {
        goScenario(String(scenarios[0] || ''));
      } else {
        window.location.href = baseUrl;
      }
    });
  }
    } catch (e) { }

  // Clicking the Preview tab while already on Preview should reload.
  const previewTab = document.getElementById('scenariosPreviewTabLink');
  if (previewTab) {
    previewTab.addEventListener('click', (ev) => {
      try {
        ev.preventDefault();
        loadPreview();
      } catch (e) { }
    });
  }

  loadPreview();
  });
}) ();
</script>
{% endblock %}