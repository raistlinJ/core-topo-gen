{% extends 'layout.html' %}
{% block title %}Run Reports{% endblock %}
{% block active_page %}{% set active_page='reports' %}{% endblock %}
{% block extra_head %}
<style>
  body { padding-bottom: 0; }
  /* Fill the remaining viewport below the app chrome (header+nav). */
  #reportsPageWrap { min-height: calc(100vh - 200px); }
</style>
{% endblock %}
{% block nav_right_extra %}
  <div class="d-flex align-items-center gap-2 small">
    <label for="refreshInterval" class="form-label mb-0">Every</label>
    <select id="refreshInterval" class="form-select form-select-sm w-auto" title="Auto-refresh interval">
      <option value="2000">2s</option>
      <option value="5000">5s</option>
      <option value="10000">10s</option>
      <option value="30000" selected>30s</option>
      <option value="60000">60s</option>
    </select>
    <span id="refreshStatus" class="text-muted">auto</span>
    <button class="btn btn-sm btn-outline-light text-dark bg-white" id="toggleRefreshBtn" type="button">Pause</button>
  </div>
{% endblock %}
{% block content %}
<div class="container-fluid mt-3 d-flex flex-column" id="reportsPageWrap">
  <div class="row flex-grow-1 align-items-stretch">
    <div class="col-3 d-flex">
      <div class="card shadow-sm mb-3 flex-fill d-flex flex-column">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold">Scenarios</span>
          <button class="btn btn-sm btn-outline-secondary" id="clearScenarioFilter" type="button" title="Clear filter" style="{% if not active_scenario %}display:none{% endif %}">Clear</button>
        </div>
        <div class="list-group list-group-flush flex-grow-1 overflow-auto" id="scenarioFilterList" style="min-height:0;">
          {% if scenarios %}
            {% for s in scenarios %}
            <button type="button" class="list-group-item list-group-item-action py-1 {% if active_scenario and active_scenario==s %}active bg-primary text-white{% endif %}" data-scen-name="{{ s }}">{{ s }}</button>
            {% endfor %}
          {% else %}
          <div class="p-2 small text-muted">No scenarios yet</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-9 d-flex">
      <div class="card mb-3 flex-fill d-flex flex-column">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <strong class="mb-0">Run History</strong>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-danger" id="runsDeleteBtn" type="button" title="Delete Selected" disabled>
              <i class="bi bi-trash"></i> Selected
            </button>
            <small class="text-muted" id="runCount"></small>
          </div>
        </div>
        <div class="table-responsive flex-grow-1" style="overflow:auto;">
          <table class="table table-sm align-middle mb-0" id="runsTable">
            <thead class="table-light">
              <tr>
                <th style="width:2rem; text-align:center;"><input type="checkbox" id="runsCheckAll"></th>
                <th style="white-space:nowrap;">Timestamp (Local)</th>
                <th>Scenario(s)</th>
                <th>Scenario XML</th>
                <th>Flow/Preview Plan</th>
                <th>Report</th>
                <th>Summary</th>
                <th>Session XML</th>
                <th style="white-space:nowrap;">Run ID</th>
              </tr>
            </thead>
            <tbody>
              {% for r in history %}
              <tr data-scenarios="{{ (r.scenario_names or [])|join('||') }}">
                <td style="text-align:center;"><input type="checkbox" class="row-select" data-run-id="{{ r.run_id or '' }}"></td>
                <td>{{ r.timestamp }}</td>
                <td class="small">{{ (r.scenario_names or [])|join(', ') }}</td>
                <td>{% if r.scenario_xml_path %}<a href="{{ url_for('download_report', path=r.scenario_xml_path) }}">scenario</a>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
                <td>{% if r.preview_plan_path %}<a href="{{ url_for('download_report', path=r.preview_plan_path) }}">plan</a>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
                <td>{% if r.report_path %}<a href="{{ url_for('download_report', path=r.report_path) }}">report</a>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
                <td>{% if r.summary_path %}<a href="{{ url_for('download_report', path=r.summary_path) }}">summary</a>{% elif r.report_path or session_path %}<span class="text-muted d-inline-flex align-items-center gap-1"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Summarizing, please wait...</span>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
                {% set session_path = r.session_xml_path or r.post_xml_path %}
                <td>{% if session_path %}<a href="{{ url_for('download_report', path=session_path) }}">session</a>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
                <td>{{ r.run_id or '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% include 'partials/dock.html' %}
{% endblock %}
{% block extra_scripts %}
<script>
  // Server-injected: scenarioNorm -> hasParticipantUrl
  let participantUrlFlags = {{ participant_url_flags|tojson }};
  function normalizeScenarioNorm(raw){
    return (raw || '').toString().trim().toLowerCase().replace(/\s+/g, ' ');
  }

let autoRefresh = true;
let refreshTimer = null;
let intervalMs = 30000;
let refreshInFlight = false;
let lastManualRefreshAt = 0;
let lastScenarioChangeAt = 0;
try {
  const stored = parseInt(localStorage.getItem('reportsRefreshMs') || '', 10);
  if ([2000,5000,10000,30000,60000].includes(stored)) intervalMs = stored;
} catch(e) {}
const tableBody = document.querySelector('#runsTable tbody');
const runsCheckAll = document.getElementById('runsCheckAll');
const runsDeleteBtn = document.getElementById('runsDeleteBtn');
const selectedRunIds = new Set();
const reportsDataBaseUrl = "{{ url_for('reports_data') }}";
const participantDetailsBaseUrl = "{{ url_for('participant_ui_details_api') }}";
let scenarioNamesCache = {{ (scenarios or [])|tojson }};
const initialScenarioFilter = {{ (active_scenario or '')|tojson }};
let activeScenarioFilter = initialScenarioFilter || null;
const clearScenarioBtn = document.getElementById('clearScenarioFilter');
if(clearScenarioBtn){ clearScenarioBtn.style.display = activeScenarioFilter ? 'inline-block':'none'; }
// Tracks whether user explicitly activated select-all across currently visible rows.
let masterSelectAllActive = false;
function getVisibleCheckboxes(){ return tableBody.querySelectorAll('tr:not(.d-none) input.row-select'); }
function updateHeader(){
  const checkboxes = getVisibleCheckboxes();
  const total = checkboxes.length;
  const checkedCount = Array.from(checkboxes).filter(cb=>cb.checked).length;
  if(runsCheckAll){
    if (masterSelectAllActive) {
      runsCheckAll.indeterminate = false;
      runsCheckAll.checked = true;
    } else {
      runsCheckAll.indeterminate = checkedCount>0 && checkedCount<total;
      runsCheckAll.checked = total>0 && checkedCount===total;
    }
  }
  if(runsDeleteBtn){ runsDeleteBtn.disabled = selectedRunIds.size===0; }
}
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function buildRow(r){
  const scenNames = (r.scenario_names||[]).join(', ');
  const rid = (r.run_id||'') || [r.timestamp||'', (r.scenario_xml_path||r.xml_path||''), (r.report_path||''), (r.summary_path||''), (r.full_scenario_path||'')].join('|');
  const sessionPath = r.session_xml_path || r.post_xml_path;
  return `<tr data-scenarios="${(r.scenario_names||[]).join('||')}">
    <td style="text-align:center;"><input type="checkbox" class="row-select" data-run-id="${rid}"></td>
    <td>${escapeHtml(r.timestamp||'')}</td>
    <td class="small">${escapeHtml(scenNames)}</td>
    <td>${r.scenario_xml_path?`<a href='/download_report?path=${encodeURIComponent(r.scenario_xml_path)}'>scenario</a>`:'<span class=\"text-muted\">n/a</span>'}</td>
    <td>${r.preview_plan_path?`<a href='/download_report?path=${encodeURIComponent(r.preview_plan_path)}'>plan</a>`:'<span class="text-muted">n/a</span>'}</td>
  <td>${r.report_path?`<a href='/download_report?path=${encodeURIComponent(r.report_path)}'>report</a>`:'<span class=\"text-muted\">n/a</span>'}</td>
  <td>${r.summary_path?`<a href='/download_report?path=${encodeURIComponent(r.summary_path)}'>summary</a>`:((r.report_path || sessionPath)?'<span class=\"text-muted d-inline-flex align-items-center gap-1\"><span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span>Summarizing, please wait...</span>':'<span class=\"text-muted\">n/a</span>')}</td>
  <td>${sessionPath?`<a href='/download_report?path=${encodeURIComponent(sessionPath)}'>session</a>`:'<span class=\"text-muted\">n/a</span>'}</td>
    <td>${escapeHtml(r.run_id||'-')}</td>
  </tr>`;
}
function renderRows(history){
  if(!tableBody) return;
  tableBody.innerHTML = history.map(buildRow).join('\n');
  applyScenarioFilter();
  updateCount();
  wireSelectionHandlers();
  if (masterSelectAllActive) {
    applyMasterSelectAll();
  }
  updateHeader();
}

function defaultScenarioName(){
  return (Array.isArray(scenarioNamesCache) && scenarioNamesCache.length) ? String(scenarioNamesCache[0]) : null;
}

function ensureScenarioSelected(){
  if(activeScenarioFilter) return;
  const def = defaultScenarioName();
  if(def) activeScenarioFilter = def;
}

function buildReportsDataUrl(){
  ensureScenarioSelected();
  if(!activeScenarioFilter) return reportsDataBaseUrl;
  const url = new URL(reportsDataBaseUrl, window.location.origin);
  url.searchParams.set('scenario', activeScenarioFilter);
  return url.pathname + url.search;
}
function updateScenarioQueryParam(){
  const url = new URL(window.location.href);
  if(activeScenarioFilter){
    url.searchParams.set('scenario', activeScenarioFilter);
  } else {
    url.searchParams.delete('scenario');
  }
  window.history.replaceState({}, '', url.toString());
}
function updateScenarioFilterControls(){
  if(clearScenarioBtn){
    const def = defaultScenarioName();
    const show = !!activeScenarioFilter && !!def && activeScenarioFilter !== def;
    clearScenarioBtn.style.display = show ? 'inline-block' : 'none';
  }
  const list = document.getElementById('scenarioFilterList');
  if(!list) return;
  list.querySelectorAll('[data-scen-name]').forEach(btn => {
    const name = btn.getAttribute('data-scen-name');
    const isActive = !!activeScenarioFilter && name === activeScenarioFilter;
    btn.classList.toggle('active', isActive);
    btn.classList.toggle('bg-primary', isActive);
    btn.classList.toggle('text-white', isActive);
  });
}
function renderScenarioButtons(){
  const list = document.getElementById('scenarioFilterList');
  if(!list) return;
  list.innerHTML = '';
  if(!scenarioNamesCache || scenarioNamesCache.length === 0){
    const empty = document.createElement('div');
    empty.className = 'p-2 small text-muted';
    empty.textContent = 'No scenarios yet';
    list.appendChild(empty);
    updateScenarioFilterControls();
    return;
  }
  ensureScenarioSelected();
  scenarioNamesCache.forEach(name => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'list-group-item list-group-item-action py-1';
    btn.dataset.scenName = name;
    btn.textContent = name;
    if(activeScenarioFilter && name === activeScenarioFilter){ btn.classList.add('active','bg-primary','text-white'); }
    btn.addEventListener('click', async () => {
      if(activeScenarioFilter === name) return; // never allow "All" by deselecting
      await setScenarioFilter(name);
    });
    list.appendChild(btn);
  });
  updateScenarioFilterControls();
}
async function setScenarioFilter(value){
  activeScenarioFilter = value || defaultScenarioName() || null;
  lastScenarioChangeAt = Date.now();
  updateScenarioQueryParam();
  updateScenarioFilterControls();
  refreshParticipantNavForScenario(activeScenarioFilter);
  await fetchHistory();
}

async function refreshParticipantNavForScenario(scenarioName){
  try {
    const scen = (scenarioName || '').toString().trim();
    if (typeof window.CORETG_PATCH_SCENARIO_NAV === 'function') {
      window.CORETG_PATCH_SCENARIO_NAV(scen);
    }
    if (!scen) {
      if (typeof window.CORETG_SET_PARTICIPANT_NAV_VISIBLE === 'function') {
        window.CORETG_SET_PARTICIPANT_NAV_VISIBLE(false);
      }
      return;
    }

    // Fast path: decide instantly from server-injected flags.
    const scenNorm = normalizeScenarioNorm(scen);
    if (participantUrlFlags && Object.prototype.hasOwnProperty.call(participantUrlFlags, scenNorm)) {
      const configured = !!participantUrlFlags[scenNorm];
      if (typeof window.CORETG_SET_PARTICIPANT_NAV_VISIBLE === 'function') {
        window.CORETG_SET_PARTICIPANT_NAV_VISIBLE(configured);
      }
      return;
    }

    const url = new URL(participantDetailsBaseUrl, window.location.origin);
    url.searchParams.set('scenario', scen);
    const res = await fetch(url.pathname + url.search, { cache: 'no-store' });
    if (!res.ok) return;
    const data = await res.json();
    const configured = !!(data && data.scenario && data.scenario.participant_link_configured);
    if (typeof window.CORETG_SET_PARTICIPANT_NAV_VISIBLE === 'function') {
      window.CORETG_SET_PARTICIPANT_NAV_VISIBLE(configured);
    }
  } catch (e) {
    // ignore
  }
}
async function fetchHistory(){
  if (refreshInFlight) return;
  refreshInFlight = true;
  try {
    const url = buildReportsDataUrl();
    const res = await fetch(url);
    if(!res.ok) return;
    const data = await res.json();
    if (data && data.participant_url_flags && typeof data.participant_url_flags === 'object') {
      participantUrlFlags = data.participant_url_flags;
    }
    const serverScenario = (data.active_scenario || '').trim();
    if(serverScenario){
      activeScenarioFilter = serverScenario;
    } else {
      // Never allow an implicit "All" state if scenarios exist.
      if(!activeScenarioFilter){
        const first = (Array.isArray(data.scenarios) && data.scenarios.length) ? String(data.scenarios[0]) : null;
        if(first) activeScenarioFilter = first;
      }
    }
    if(Array.isArray(data.history)) renderRows(data.history);
    if(Array.isArray(data.scenarios)){
      scenarioNamesCache = data.scenarios;
      renderScenarioButtons();
    }
    updateScenarioQueryParam();
    updateScenarioFilterControls();
  } catch(e) {
    // transient errors ignored
  } finally {
    refreshInFlight = false;
  }
}

async function refreshNow(reason){
  const status = document.getElementById('refreshStatus');
  if (!autoRefresh) return;
  const now = Date.now();
  // If the user just clicked a scenario filter, don't race it.
  if (now - lastScenarioChangeAt < 800) return;
  // Simple throttle for noisy events (click + focus + visibility can stack).
  if (now - lastManualRefreshAt < 800) return;
  lastManualRefreshAt = now;
  if (status) status.textContent = 'refreshingâ€¦';
  await fetchHistory();
  refreshParticipantNavForScenario(activeScenarioFilter);
  if (status) status.textContent = 'auto';
  // Restart the timer so the next refresh is `intervalMs` from now.
  schedule();
}

function schedule(){
  if(refreshTimer) clearTimeout(refreshTimer);
  if(!autoRefresh) return;
  refreshTimer = setTimeout(async () => { await fetchHistory(); schedule(); }, intervalMs);
}
document.getElementById('toggleRefreshBtn').addEventListener('click', () => {
  autoRefresh = !autoRefresh;
  document.getElementById('toggleRefreshBtn').textContent = autoRefresh? 'Pause':'Resume';
  document.getElementById('refreshStatus').textContent = autoRefresh? 'auto':'paused';
  schedule();
});

const sel = document.getElementById('refreshInterval');
if (sel) {
  if ([2000,5000,10000,30000,60000].includes(intervalMs)) {
    sel.value = String(intervalMs);
  }
  sel.addEventListener('change', ()=>{
    const v = parseInt(sel.value, 10);
    if (!isNaN(v) && v > 0) {
      intervalMs = v;
      try { localStorage.setItem('reportsRefreshMs', String(intervalMs)); } catch(e) {}
      schedule();
    }
  });
}

function applyScenarioFilter(){
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(r => {
    if(!activeScenarioFilter){ r.classList.remove('d-none'); return; }
    const scenAttr = r.getAttribute('data-scenarios')||'';
    const match = scenAttr.split('||').filter(Boolean).includes(activeScenarioFilter);
    r.classList.toggle('d-none', !match);
  });
  updateHeader();
}
function updateCount(){
  const rows = Array.from(tableBody.querySelectorAll('tr'));
  const visible = rows.filter(r=>!r.classList.contains('d-none')).length;
  document.getElementById('runCount').textContent = visible + ' run' + (visible===1?'':'s');
}
document.getElementById('clearScenarioFilter').addEventListener('click', async () => {
  const def = defaultScenarioName();
  if(!def) return;
  await setScenarioFilter(def);
});
renderScenarioButtons();
applyScenarioFilter();
updateCount();
// Bind row + header selection handlers for initial server-rendered rows
wireSelectionHandlers();
// Refresh immediately on load, then start polling.
refreshNow('load');

// Refresh when the user returns attention to the page.
window.addEventListener('focus', () => { refreshNow('focus'); });
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') refreshNow('visible');
});
// Refresh when the page is clicked (discoverability + quick update), but do not
// interfere with scenario selection or other controls.
document.addEventListener('click', (ev) => {
  try {
    const target = ev && ev.target ? ev.target : null;
    if (!target || !(target instanceof Element)) { refreshNow('click'); return; }
    // Ignore clicks on interactive controls / scenario list / table.
    if (
      target.closest('#scenarioFilterList') ||
      target.closest('#runsTable') ||
      target.closest('#navRightExtras') ||
      target.closest('button') ||
      target.closest('a') ||
      target.closest('input') ||
      target.closest('select') ||
      target.closest('textarea') ||
      target.closest('label')
    ) {
      return;
    }
  } catch(e) {}
  refreshNow('click');
}, { capture: true });

schedule();

function wireSelectionHandlers(){
  const checkboxes = tableBody.querySelectorAll('input.row-select');
  checkboxes.forEach(cb=>{
    const id = cb.getAttribute('data-run-id')||'';
    if(id && selectedRunIds.has(id)) cb.checked = true; else cb.checked = false;
    cb.addEventListener('change', ()=>{
      const rid = cb.getAttribute('data-run-id')||'';
      if(!rid) return;
      if(cb.checked) {
        selectedRunIds.add(rid);
      } else {
        selectedRunIds.delete(rid);
        if (masterSelectAllActive) masterSelectAllActive = false; // user manually diverged
      }
      updateHeader();
    });
  });
  if(runsCheckAll){
    runsCheckAll.onchange = ()=>{
      const newVal = !!runsCheckAll.checked;
      if (newVal) {
        masterSelectAllActive = true;
        applyMasterSelectAll();
      } else {
        masterSelectAllActive = false;
        const visibles = getVisibleCheckboxes();
        visibles.forEach(cb=>{ const rid = cb.getAttribute('data-run-id')||''; if(!rid) return; cb.checked = false; selectedRunIds.delete(rid); });
        updateHeader();
      }
    };
  }
  updateHeader();
}

function applyMasterSelectAll(){
  const visibles = getVisibleCheckboxes();
  visibles.forEach(cb=>{ const rid = cb.getAttribute('data-run-id')||''; if(!rid) return; cb.checked = true; selectedRunIds.add(rid); });
  updateHeader();
}

async function deleteSelectedRuns(){
  const ids = Array.from(selectedRunIds).filter(Boolean);
  if(ids.length===0) return;
  if(!confirm(`Delete ${ids.length} selected run entr${ids.length===1?'y':'ies'}?\nThis deletes run history entries and artifacts under outputs/ (scenario XMLs, session captures, bundles). Reports under ./reports are preserved.`)) return;
  try{
    const res = await fetch('/reports/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ run_ids: ids }) });
    if(res.ok){ selectedRunIds.clear(); await fetchHistory(); } else { alert('Delete failed'); }
  } catch(e){ alert('Delete failed'); }
}
document.getElementById('runsDeleteBtn')?.addEventListener('click', deleteSelectedRuns);
</script>
{% endblock %}
