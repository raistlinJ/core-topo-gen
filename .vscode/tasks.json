{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Restart Web UI detached (9090)",
      "type": "shell",
      "command": "cd /Users/jcacosta/Documents/core-topo-gen && pid=$(lsof -t -iTCP:9090 -sTCP:LISTEN 2>/dev/null | head -n 1) && if [ -n \"$pid\" ]; then kill \"$pid\"; fi && mkdir -p outputs/logs && nohup env CORETG_PORT=9090 WEBAPP_LOG_LEVEL=INFO PYTHONUNBUFFERED=1 /Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python -u -m main > outputs/logs/webui-9090.log 2>&1 & echo \"NEW_PID=$!\"",
      "isBackground": false
    },
    {
      "label": "Healthz 9090",
      "type": "shell",
      "command": "curl -fsS http://127.0.0.1:9090/healthz && echo",
      "isBackground": false
    },
    {
      "label": "Check Web UI health (9090)",
      "type": "shell",
      "command": "cd /Users/jcacosta/Documents/core-topo-gen && curl -fsS -I http://127.0.0.1:9090/healthz | head",
      "isBackground": false
    },
    {
      "label": "Tail Web UI log",
      "type": "shell",
      "command": "cd /Users/jcacosta/Documents/core-topo-gen && tail -n 80 outputs/logs/webui-9090.log | cat",
      "isBackground": false
    },
    {
      "label": "Smoke Generator Packs (auth)",
      "type": "shell",
      "command": "cd /Users/jcacosta/Documents/core-topo-gen && set -e && rm -f /tmp/cg_cookie_pack.txt /tmp/cg_pack.zip /tmp/cg_pack_dl.zip /tmp/cg_pack_export_all.zip /tmp/cg_pack_id.txt /tmp/cg_fg.json && /Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport zipfile, shutil\nfrom pathlib import Path\nbase = Path('/tmp/cg_pack_src')\nzip_path = Path('/tmp/cg_pack.zip')\nshutil.rmtree(base, ignore_errors=True)\nzip_path.unlink(missing_ok=True)\n\ngen_dir = base / 'flag_generators' / 'smoke_test_gen'\ngen_dir.mkdir(parents=True, exist_ok=True)\n(gen_dir / 'manifest.yaml').write_text(\n    'manifest_version: 1\\n'\n    'id: smoke-test-gen\\n'\n    'kind: flag-generator\\n'\n    'name: Smoke Test Generator\\n'\n    'runtime:\\n'\n    '  type: docker-compose\\n'\n    '  compose_file: docker-compose.yml\\n'\n    '  service: generator\\n',\n    encoding='utf-8',\n)\n(gen_dir / 'docker-compose.yml').write_text(\n    'version: \"3.8\"\\n'\n    'services:\\n'\n    '  generator:\\n'\n    '    image: alpine:3.19\\n'\n    '    command: [\"sh\", \"-lc\", \"echo smoke\"]\\n',\n    encoding='utf-8',\n)\n(gen_dir / 'run.py').write_text('print(\"smoke\")\\n', encoding='utf-8')\n\nwith zipfile.ZipFile(zip_path, 'w', compression=zipfile.ZIP_DEFLATED) as z:\n    for p in base.rglob('*'):\n        if p.is_file():\n            z.write(p, p.relative_to(base))\nprint(zip_path)\nPY\n\ncurl -sS -c /tmp/cg_cookie_pack.txt -o /dev/null -X POST http://127.0.0.1:9090/login -d 'username=coreadmin' -d 'password=coreadmin'\n\n# Upload the pack zip\ncurl -sS -b /tmp/cg_cookie_pack.txt -c /tmp/cg_cookie_pack.txt -o /dev/null -X POST http://127.0.0.1:9090/generator_packs/upload -F zip_file=@/tmp/cg_pack.zip\n\n# Read the newest pack id from state (best-effort ordering by installed_at)\n/Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport json\nfrom pathlib import Path\nstate_path = Path('outputs/installed_generators/_packs_state.json')\ndata = json.loads(state_path.read_text('utf-8')) if state_path.exists() else {}\npacks = [p for p in (data.get('packs') or []) if isinstance(p, dict)]\npacks.sort(key=lambda p: p.get('installed_at') or '')\nprint((packs[-1].get('id') if packs else '') or '')\nPY > /tmp/cg_pack_id.txt\nPACK_ID=$(cat /tmp/cg_pack_id.txt | tr -d '\\n' | tr -d '\\r')\necho \"PACK_ID=$PACK_ID\"\nif [ -z \"$PACK_ID\" ]; then echo 'ERROR: no pack id found' && exit 2; fi\n\n# Ensure the installed generator is discoverable\ncurl -sS -b /tmp/cg_cookie_pack.txt -o /tmp/cg_fg.json http://127.0.0.1:9090/flag_generators_data\n/Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport json\nobj=json.load(open('/tmp/cg_fg.json','r',encoding='utf-8'))\ngens=obj.get('generators') or []\nids=set((g.get('id') or '') for g in gens if isinstance(g,dict))\nprint('has_smoke_test_gen=', 'smoke-test-gen' in ids)\nassert 'smoke-test-gen' in ids\nPY\n\n# Download the pack and sanity-check zip contents\ncurl -sS -b /tmp/cg_cookie_pack.txt -o /tmp/cg_pack_dl.zip http://127.0.0.1:9090/generator_packs/download/$PACK_ID\n/Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport zipfile\nz=zipfile.ZipFile('/tmp/cg_pack_dl.zip','r')\nnames=set(z.namelist())\nassert any(n.endswith('manifest.yaml') for n in names), sorted(list(names))[:20]\nassert any(n.endswith('docker-compose.yml') for n in names), sorted(list(names))[:20]\nprint('download_zip_ok=1')\nPY\n\n# Export all should include at least one packs/*.zip when installed\ncurl -sS -b /tmp/cg_cookie_pack.txt -o /tmp/cg_pack_export_all.zip http://127.0.0.1:9090/generator_packs/export_all\n/Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport zipfile\nz=zipfile.ZipFile('/tmp/cg_pack_export_all.zip','r')\nnames=z.namelist()\nassert any(n.startswith('packs/') and n.endswith('.zip') for n in names), names\nprint('export_all_ok=1')\nPY\n\n# Uninstall pack\ncurl -sS -b /tmp/cg_cookie_pack.txt -o /dev/null -X POST http://127.0.0.1:9090/generator_packs/delete/$PACK_ID\n\n# Ensure state no longer contains the pack id\n/Users/jcacosta/Documents/core-topo-gen/.venv312/bin/python - <<'PY'\nimport json\nfrom pathlib import Path\npack_id = open('/tmp/cg_pack_id.txt','r',encoding='utf-8').read().strip()\nstate_path = Path('outputs/installed_generators/_packs_state.json')\ndata = json.loads(state_path.read_text('utf-8')) if state_path.exists() else {}\npacks = [p for p in (data.get('packs') or []) if isinstance(p, dict)]\nassert all((p.get('id') or '') != pack_id for p in packs)\nprint('uninstall_state_ok=1')\nPY\n\necho 'SMOKE_GENERATOR_PACKS_OK=1'\n",
      "isBackground": false
    }

  ]
}