import math

from core_topo_gen.planning.vulnerability_plan import VulnerabilityItem, compute_vulnerability_plan


def test_vulnerability_density_requires_weight_rows():
    base_pool = 20
    density = 0.75
    items = [
        VulnerabilityItem(
            name='Specific',
            density=density,
            abs_count=3,
            kind='Specific',
            factor=0.0,
            metric='Count',
        )
    ]
    plan, breakdown = compute_vulnerability_plan(base_pool, density, items)
    assert plan == {'Specific': 3}
    assert breakdown['derived_pool'] == 0
    assert breakdown['has_weight_based'] is False
    assert breakdown['final_total'] == 3


def test_vulnerability_density_uses_base_pool_for_weights():
    base_pool = 40
    density = 0.5
    items = [
        VulnerabilityItem(
            name='SSHCreds',
            density=density,
            abs_count=0,
            kind='Category',
            factor=1.0,
            metric='Weight',
        )
    ]
    plan, breakdown = compute_vulnerability_plan(base_pool, density, items)
    assert plan['SSHCreds'] == 20
    assert breakdown['derived_pool'] == math.floor(base_pool * density)
    assert breakdown['has_weight_based'] is True
    assert breakdown['final_total'] == plan['SSHCreds']
