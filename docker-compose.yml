services:
  nginx:
    profiles: ["nginx"]
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: core-topo-gen-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Host-web mode by default: proxy to Web UI running on the host at 127.0.0.1:9090
      - ./nginx/nginx-hostweb.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs
    environment:
      - CERT_DAYS=${CERT_DAYS:-365}
      - CERT_SUBJECT=${CERT_SUBJECT:-/CN=localhost}
      - CERT_SANS=${CERT_SANS:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - app_net

  envoy:
    profiles: ["envoy"]
    image: envoyproxy/envoy:v1.31-latest
    container_name: core-topo-gen-envoy
    command: ["-c", "/etc/envoy/envoy.yaml"]
    ports:
      - "80:80"
      - "443:443"
      - "9901:9901"  # admin
    volumes:
      - ./envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./nginx/certs:/etc/envoy/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - app_net

networks:
  app_net:
    driver: bridge
