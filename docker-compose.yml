services:
  web:
    build:
      # Build from repo root so requirements.txt and core_topo_gen/ are available.
      context: .
      dockerfile: webapp/Dockerfile
      network: host
    container_name: core-topo-gen-web
    environment:
      - CORE_HOST=${CORE_HOST:-host.docker.internal}
      - CORE_PORT=${CORE_PORT:-50051}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - ${CORETG_DNS_1:-1.1.1.1}
      - ${CORETG_DNS_2:-8.8.8.8}
    volumes:
      # Persist state/artifacts on the host.
      - ./outputs:/app/outputs
      - ./reports:/app/reports
      - ./uploads:/app/uploads
    network_mode: host
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:9090/healthz', timeout=3)"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    restart: unless-stopped

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
      network: host
    container_name: core-topo-gen-proxy
    depends_on:
      web:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - CERT_DAYS=${CERT_DAYS:-365}
      - CERT_SUBJECT=${CERT_SUBJECT:-/CN=localhost}
      - CERT_SANS=${CERT_SANS:-}
    dns:
      - ${CORETG_DNS_1:-1.1.1.1}
      - ${CORETG_DNS_2:-8.8.8.8}
    restart: unless-stopped
    networks:
      - app_net

networks:
  app_net:
    driver: bridge
